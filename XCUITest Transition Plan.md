# XCUITest Transition Plan

Currently, Detox iOS resides entirely in the user process. As such, process management is entirely at the responsibility of Detox JS. When launching the user process, Detox JS injects the Detox framework using the `DYLD_INSERT_LIBRARIES` environment variable.

XCUITest, or UI testing built on top of Apple’s XCTest testing framework, is a new model for test management. Unlike unit testing using XCTest, which runs within the app process, UI testing splits testing from the app process, and creates a two-process architecture:

- The test runner process, responsible for app management and test execution
- The app process, running the user code

This model recreates the [black-box testing](https://en.wikipedia.org/wiki/Black-box_testing) method, where the app is encapsulated in its own process, and the test runner process only has minimal information about the app and UI state.

https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/testing_with_xcode/chapters/09-ui_testing.html

Detox, rather than being black-box testing framework, implements an improved method called [gray-box testing](https://en.wikipedia.org/wiki/Gray_box_testing), where app states are tracked for providing better app synchronization.

### Motivation

The move to XCUITest is primarily intended to allow better app management, access to multiple apps from the same test context, access to system UI elements (through XCUITest’s matchers and actions) and hardware device running, which are not possible in the existing Detox architecture.

### Challenges

Detox needs to be re-arcitectured to correctly use the two-process architecture; the Detox framework needs to be split up, where management tasks are performed in the test-runner process, while operative tasks (matching, actions, synchronization) are performed in the app process. The two processes will need to communicate between them. Detox JS’s process management (launch, terminate, bring to front, etc.) will need to be moved to the Detox test-runner process, becoming new invoke commands.

One major challenge is debugging in the two-process architecture. There are multiple points of potential failure, such as bugs in the test-runner process code, bugs in the app process code, bugs in the communication layers and so on. On top of that, the user’s app bugs need to also be taken into account when debugging. A debugging strategy needs to be devised taking all these challenges into account. Debugging two processes in Xcode is possible when running in a UI testing context, but that requires major changes to the user’s project, which is something that Detox has shied away from, due to “Xcode challenged” users coming from web development. **Without such strategy, Detox will quickly become impossible to debug.**

The test-runner app is created as closed-source, precompiled app by Apple, which loads a testing bundle during runtime. This will add additional steps to distribution, and challenges to debugging.

### Plan

The move to XCUITest infrastructure is planned in multiple phases, each building on the first, base phase. Later phases are independent, and will provide feature expansion as needs rise.

### Phase 1

This is the base phase, implementing the basic two-process architecture.

1. Create the basic two process structure
   1. Create the test bundle
   2. Move appropriate code from the current Detox framework into the test bundle
   3. Add [DetoxIPC](https://github.com/wix/DetoxIPC) to both test bundle and app framework
2. Remove process management code from Device.js
   1. Identify all the API for process management
   2. Remove existing functionality
   3. Convert Detox JS API calls to new invoke commands
3. Build process management in the test-runner process
   1. The test-runner process will need to book-keep processes
   2. Framework injection will now move to this code
   3. This is the place to set up IPC connections, etc.
4. Use IPC to perform Detox tasks
   1. Tasks such as matching, actions, expecting, sync
5. During build, create a prepackaged Detox with all necessary portions
   1. Precompiled test-process app (generated by Xcode)
   2. Precompiled test bundle, containing Detox’ test-runner code
   3. Precompiled app framework, containing Detox’ app-process code
   4. Create appropriate scripts that will be executed during testing on user’s machine
      1. These scripts will need to modify internal test bundle plist files to allow for launch arguments (see https://github.com/wix/Detox/blob/XCUITest/detox/ios/run_test.sh for example)
      2. These files’ formats may change with time and new versions of Xcode, requiring multiple scripts or dropping old Xcode versions support
6. Change Detox JS to call scripts instead of current logic
   1. The scripts created in 5-4 will now be responsible for launching the test-runner process, so JS needs to call those with the appropriate parameters (such as session information)

**This phase, if implemented correctly, should be relatively transparent to the user, requiring little to no modification to user tests and tooling.**

Work on this phase was already started in the [XCUITest branch](https://github.com/wix/Detox/tree/XCUITest), but that was attempted on a very outdated codebase. The branch has been kept alive for referencing. Some of the above steps were performed there, and can give ideas how to accomplish them on modern Detox codebase.

### Further Phases

Once the base XCUITest phase is implemented and stable, further phases can now take advantage of the XCUITest architecture to implement new features that were not possible before.

#### Multiple App Support Phase

Since XCUITest supports multiple apps through [`XCUIApplication`](https://developer.apple.com/documentation/xctest/xcuiapplication), Detox will be able to take advantage of this in order to support multiple apps, dispatching actions to each app independently. If the test-runner process is correctly implemented with this in mind, implementing multiple app support should require minimal to no changes to the Detox iOS code. 

On Detox JS, the correct approach is to change the syntax to an object-oriented API, which will then allow executing actions/expectations for each app independently. An example syntax:

```js
const app1 = Application("appName");
app1.launchArguments = ["-arg1", "val1", "-arg2", "val2"];
await app1.install();
await app1.launch();

const app2 = Application("appName");
app2.launchArguments = ["-arg1", "val1", "-arg2", "val2"];
await app2.install();
await app2.launch();

const element = app1.elementByLabel("test").atIndex(0);
await expect(element.visible);
await element.tap();

const elementToScroll = app2.elementById("scroll");
await elementToScroll.scroll(100, "up");

const elementToReach = app2.elementById("view");
await elementToScroll.scrollUntil(elementToReach.visible, 50, "down");
```



#### XCUITest Matcher/Action Phase

XCUITest’s matchers and actions have both advantages and disadvantages to Detox’ internal matchers and actions. Since XCUITest elements are accessibility proxies, they have access to elements system-wide, and elements such as permission alerts and security dialogs, which are rendered by Apple daemons, rather than the user process, can be accessed and interacted with. On the other hand, due to only having access to a very small set of attributes for these proxies, and no real access the actual objects, this matching/interaction system is very limited in nature. Accessibility proxies also allow matching and interaction with web elements in Safari and app web views.

A mechanism can be devised, where Detox’ user decides which matcher/action system to use, so that advantage can be taken of both systems’ strengths. Internally, Detox iOS will decide which system to route these actions to.

An example syntax:

```js
const app1 = Application("appName");
await app1.install();
await app1.launch();

const element = app1.elementByLabel("test").atIndex(0);
await expect(element.visible);
await element.tap();

const permissionElement = app1.xcuitest().elementByLabel("OK");
await permissionElement.tap();
```



#### Hardware Device Support Phase

Challenges with running Detox tests on hardware devices has been documented on the [GitHub issue](https://github.com/wix/Detox/issues/95), specifically in [this comment](https://github.com/wix/Detox/issues/95#issuecomment-448365050). Moving to the XCUITest architecture alleviates many of the issues Detox had before. Since `xcodebuild` is now responsible for launching the test-runner process, it can target hardware devices in addition to simulators. Since the test-runner process is responsible for launching the use process, it can provide the appropriate environment variables that Detox needs in order to inject the Detox framework into the user process.

Not all challenges are solved by XCUITest, however. For simulators, there is [AppleSimulatorUtils](https://github.com/wix/AppleSimulatorUtils), which provide a lot of functionality that is not possible on hardware devices. Some can be alleviated by implementing XCUITest Matchers/Actions, allowing interaction with system prompts, such as permission alerts. But still, many limitations remain.

A tool that might assist is https://github.com/datatheorem/strongarm